# イベント確定ロジック: フローとテスト計画

## 1. 現在のロジックフロー (`finalize-event`)

バックエンドロジックは以下の8ステップで集合場所とレストランを決定します:

1.  **参加者の取得**:
    *   `event_id` に関連付けられたすべてのユーザーを取得します。
    *   位置情報が無効（lat/lngが0またはnull）なユーザーを除外します。
2.  **重心の計算**:
    *   全有効参加者の単純な地理的中心（緯度・経度の平均）を計算します。
3.  **候補駅の検索 (Google Places API)**:
    *   **[有料]**: 重心から半径 **2km** 以内の電車・地下鉄駅を検索します。
    *   *フォールバック*: 駅が見つからない場合、重心そのものを「中間地点」として使用します。
4.  **到着時刻の決定**:
    *   参加者のスケジュール（`schedules` テーブル）を確認し、最も多くの人が空いている日時を探します。
    *   *フォールバック*: スケジュールがない場合、**次の金曜日の19:00** をデフォルトとします。
5.  **移動時間の計算 (Google Routes API)**:
    *   **[有料]**: 全参加者から全候補駅への「乗換・移動時間マトリックス」をリクエストします。
    *   これにより、すべての組み合わせの移動時間（秒）が返されます。
6.  **最適駅の選択 (ミニマックス法)**:
    *   目標: **最も移動時間が長い人の負担を最小限に抑えること**。
    *   ロジック:
        1.  各駅について、そこに行くのに最も時間がかかるユーザー (`max_duration`) を見つけます。
        2.  全駅の中で、この `max_duration` が **最も小さい** 駅を選択します。
7.  **レストラン検索 (ホットペッパーグルメAPI)**:
    *   **[無料]**: 選択された駅から半径 **300m〜500m**（レンジ3）以内のレストランを検索します。
    *   画像、予算、キャッチコピーなどの詳細を取得します。
8.  **データベース更新**:
    *   `events` テーブルを以下で更新します:
        *   `target_station` (決定した駅)
        *   `restaurant_info` (レストラン一覧)
        *   `confirmed_date` (到着時刻)

---

## 2. テスト計画 (コスト削減戦略)

テスト実行のたびにGoogle Maps Platformのコストを発生させず、「ステップバイステップ」でロジックを検証するために、**モックを使用したユニットテスト**を行います。

### 戦略: モックを使用したDenoネイティブテスト
`deno test` を使用してローカルで実行されるテストファイル `supabase/functions/finalize-event/test.ts` を作成します。

**重要なコンセプト**:
実際のGoogle/ホットペッパーAPIを呼び出す代わりに、`fetch` 関数を **インターセプト（横取り）** し、あらかじめ定義された **偽のJSONデータ（モックデータ）** を返します。

### テストシナリオ

#### シナリオ1: ロジック検証 (APIコストなし)
*   **目標**: Googleが特定の移動時間を返したと仮定した場合に、コードが正しく「最適駅」を選択するか検証する。
*   **設定**:
    *   ユーザーA (東京)
    *   ユーザーB (横浜)
    *   モック駅: "品川" (中間), "大宮" (遠方)
    *   **モックマトリックス**:
        *   品川へ: A=15分, B=15分 → 最大15分
        *   大宮へ: A=30分, B=60分 → 最大60分
*   **期待値**: 関数は「品川」を選択する (15分 < 60分)。

#### シナリオ2: データマッピング検証
*   **目標**: ホットペッパーAPIからのデータが、我々の `Restaurant` インターフェース（画像、予算、キャッチコピーなど）に正しくマッピングされているか検証する。
*   **設定**:
    *   詳細なデータを含むモックのホットペッパーレスポンス。
*   **期待値**: 返されたオブジェクトに正しい `photo.pc.l` のURLや予算テキストが含まれていること。

### 実装手順

1.  **リファクタリング**: `index.tsx` 内のヘルパー関数（`calculateCentroid`, `computeTransitMatrix` ロジックなど）をエクスポートし、テストファイルからインポートできるようにする。
2.  **テストファイル作成**: `supabase/functions/finalize-event/tests/logic_test.ts` を作成する。
3.  **実行**: `deno test` をローカルで実行する。

このアプローチにより、APIコールを1回も行うことなく、ロジックが100%正しいことを保証できます。
